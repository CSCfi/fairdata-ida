1a2,8
> /*
>  * This file is part of the IDA research data storage service
>  *
>  * @author   CSC - IT Center for Science Ltd., Espoo Finland <servicedesk@csc.fi>
>  * @link     https://research.csc.fi/
>  */
> 
61a69,70
> use OCP\Util;
> use \Firebase\JWT\JWT;
613,623c622,632
< 		//try to set the maximum execution time to 60min
< 		if (strpos(@ini_get('disable_functions'), 'set_time_limit') === false) {
< 			@set_time_limit(3600);
< 		}
< 		@ini_set('max_execution_time', '3600');
< 		@ini_set('max_input_time', '3600');
< 
< 		//try to set the maximum filesize to 10G
< 		@ini_set('upload_max_filesize', '10G');
< 		@ini_set('post_max_size', '10G');
< 		@ini_set('file_uploads', '50');
---
>         //try to set execution time limits to 30 days
>         if (strpos(@ini_get('disable_functions'), 'set_time_limit') === false) {
>             @set_time_limit(2592000);
>         }
>         @ini_set('max_execution_time',2592000);
>         @ini_set('max_input_time', 2592000);
> 
>         //try to set the maximum filesize to 10TB and upload of up to 1 million files
>         @ini_set('upload_max_filesize', '10000G');
>         @ini_set('post_max_size', '10000G');
>         @ini_set('file_uploads', '1000000');
895a905
>         Util::writeLog('ida', 'base.php: handleRequest', \OCP\Util::DEBUG);
1014a1025
>         Util::writeLog('ida', 'base.php: handleLogin', \OCP\Util::DEBUG);
1015a1027,1030
> 		$hostname = $_SERVER['SERVER_NAME'];
> 		$domain = substr($hostname, strpos($hostname, '.') + 1);
> 		$prefix = preg_replace('/[^a-zA-Z0-9]/', '_', $domain);
> 
1022,1027d1036
< 		if (isset($_COOKIE['nc_username'])
< 			&& isset($_COOKIE['nc_token'])
< 			&& isset($_COOKIE['nc_session_id'])
< 			&& $userSession->loginWithCookie($_COOKIE['nc_username'], $_COOKIE['nc_token'], $_COOKIE['nc_session_id'])) {
< 			return true;
< 		}
1030a1040,1066
> 
> 		if (isset($_COOKIE[$prefix . '_fd_sso_session'])) {
> 
> 		    Util::writeLog('ida', 'base.php: handleLogin: domain=' . $domain
> 		                  . ' fd_sso_session_id=' . $_COOKIE[$prefix . '_fd_sso_session_id']
> 		                  . ' fd_sso_session=' . $_COOKIE[$prefix . '_fd_sso_session']
> 						  , \OCP\Util::DEBUG);
> 
> 			$key =\OC::$server->getSystemConfig()->getValue('SSO_KEY');
> 
> 			$session = JWT::decode($_COOKIE[$prefix . '_fd_sso_session'], $key, array('HS256'));
> 
> 			if ($session) {
> 
> 			    Util::writeLog('ida', 'base.php: handleLogin: session=' . json_encode($session), \OCP\Util::DEBUG);
> 
> 				if ($session->id == $_COOKIE[$prefix . '_fd_sso_session_id']
> 				    && $session->fairdata_user
> 				    && $session->fairdata_user->id
> 				    && $session->services 
> 				    && $session->services->IDA 
> 			        && $userSession->loginWithSSOSession($session->id, $session->fairdata_user->id)) {
> 			        return true;
> 		        }
> 			}
> 		}
> 
